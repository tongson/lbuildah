= buildah
:toc:
:toc-placement!:

A wrapper for https://github.com/containers/buildah[buildah(1)] commands. Create OCI containers in Lua instead of Dockerfile instructions or shell scripts. With buildah you have built-in layer squashing, daemon-less operation, and capability for regular(non-root) users to create containers among other things. This wrapper also has useful abstractions such as removing whole toolchains from the container's filesystem like Alpine apk-tools and Debian apt/dpkg.

A DSL module for LadyLua.

:note-caption: :information_source:
[NOTE]
====
All instructions will signal an exit on error.
====

toc::[]

== *FROM* ([_IMAGE_][, _ID_][, _ASSETS_])
Creates a new working container, either from scratch, an image, or using an existing container as a starting point.

=== Arguments
[options="header"]
|===
|Required |Type |Description |Default |Example
|No | string |Container image |scratch   |docker://docker.io/library/debian:buster-slim
|No |string |A 27-character KSUID. If set, reuses the previously created container with specified ID  |Generated KSUID |1kk...
|No |string |Assets directory |current directory "." |/home/ed/buildah
|===


== *ADD* (_SOURCE_, _DESTINATION_[, _CHOWN_][, _CHMOD_])
Adds the contents of a file, URL, or directory to a destination path within the container.

=== Arguments
[options="header"]
|===
|Required |Type |Description |Default |Example
|Yes |string |File or URL | |sysctl.conf
|Yes |string |Path | |/etc/sysctl.conf
|No  |string |chown string, user and group ownership of destination |root:root |ed:ed
|No  |string |chmod string, access permissions of destination |0700 |0644
|===

== *RUN* (_COMMAND_)
Runs a specified command and arguments using the container's root filesystem as a root filesystem.

=== Arguments
[options="header"]
|===
|Required |Type |Description |Default |Example
|Yes |string |Command and arguments as one long string | |apk add vim
|===

== *SCRIPT* (_FILE_)
Runs a shell script under the container's root filesystem. Require's a `/bin/sh` inside the container.

=== Arguments
[options="header"]
|===
|Required |Type |Description |Default |Example
|Yes |string |Shell script, without a leading (/) it reads from the *ASSETS* directory set in `FROM()` | |find_suid.sh
|===

== *APT_GET* (_COMMAND_)
Run Debian `apt-get` command and arguments.

=== Arguments
[options="header"]
|===
|Required |Type |Description |Default |Example
|Yes |string |apt-get commands as one long string | |install tmux
|===

== *APT_PURGE* (_PACKAGE_)
Run Debian `dpkg --purge` on specified package.

=== Arguments
[options="header"]
|===
|Required |Type |Description |Default |Example
|Yes |string |Debian package name | |tmux
|===

== *APK_UPGRADE* ()
Run `/sbin/apk upgrade --no-cache --available --no-progress` inside an Alpine Linux container.

No arguments.

== *APK_ADD* (_PACKAGES_)
Install packages inside an Alpine Linux container.

=== Arguments
[options="header"]
|===
|Required |Type |Description |Default |Example
|Yes |string |Alpine packages as one long string | |strace
|===

== *COPY* (_SOURCE_, _DESTINATION_[, _CHOWN_][, _CHMOD_])
Copy file to a destination path within the container.

=== Arguments
[options="header"]
|===
|Required |Type |Description |Default |Example
|Yes |string |File, without a leading (/) it attempts to copy from the *ASSETS* directory set in `FROM()` | |sysctl.conf
|No |string |Path | Copies _SOURCE_ to the container's root(/) directory |/etc/sysctl.conf
|No  |string |chown string, user and group ownership of destination |root:root |ed:ed
|No  |string |chmod string, access permissions of destination |0700 |0644
|===

== *MKDIR* (_DIRECTORY_[, _MODE_])
Creates directories and parent directories as needed within the container.

=== Arguments
[options="header"]
|===
|Required |Type |Description |Default |Example
|Yes |string |Directory | | /home/ed/bin
|No |string |Directory mode as in chmod(1) | |0700
|===
